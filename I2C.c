/*
 * I2C Driver for AVR Atmega32
 *
 *  Created on: Apr, 17, 2017
 *      Author: Vagobeka
 */
#include "I2C.h"
/*
===========================================================================================================
                                    ##### Building the Registers of I2C #####
===========================================================================================================
*/
#define TWBR   (*((volatile u8*)(0x20)))
#define TWSR   (*((volatile u8*)(0x21)))
#define TWAR   (*((volatile u8*)(0x22)))
#define TWDR   (*((volatile u8*)(0x23)))
#define TWCR   (*((volatile u8*)(0x56)))
/*
###########################################################################################################
################################################   MASTER   ###############################################
###########################################################################################################
*/
/*
===========================================================================================================
                                    ##### I2C Master Initialization #####
===========================================================================================================
*/
void I2C_vidMasterInit(void)
{
	/*Bit Rate is 50KHz with CLK 16MHz*/
	TWBR = 152;
	/*TWPS0:1 -> Prescaler (1)*/
	TWSR = 0x00;
	/*Enable I2C*/
	TWCR = (1<<I2C_ENABLE);
}
/*
===========================================================================================================
                                          ##### Master Sending Start #####
===========================================================================================================
*/
void I2C_vidStart(void)
{
	/*TWINT(INT_FLAG) MUST be cleared before any operation*/
	TWCR = ((1<<INT_FLAG) | (1<<START) | (1<<I2C_ENABLE));
	/*Waiting for the INT_FLAG to be set*/
	while ((TWCR & (1 << INT_FLAG)) == 0);
}
/*
===========================================================================================================
                                           ##### Master Sending Stop #####
===========================================================================================================
*/
void I2C_vidStop(void)
{
	//TWINT MUST be cleared before any operation
	//STOP Condition Bit4
	TWCR = ((1<<INT_FLAG) | (1<<STOP) | (1<<I2C_ENABLE));
}

/*
###########################################################################################################
################################################   SLAVE   ################################################
###########################################################################################################
*/

/*
===========================================================================================================
                                    ##### I2C Slave Initialization #####
===========================================================================================================
*/
void I2C_vidSlaveInit(u8 slaveAddress,u8 generalCall)
 {
	/*Setting up the Slave Address*/
	TWAR = (slaveAddress <<1);
	/*Setting up the General Call*/
	if (generalCall == GeneralCallON)
	{
		TWAR |= (1 << GeneralCall_BIT);
	} else {
		TWAR &= ~(1 << GeneralCall_BIT);
	}

	/*Enable I2C*/
	TWCR = (1 << I2C_ENABLE);
}
/*
===========================================================================================================
                                    ##### Slave Listening to be Addressed #####
===========================================================================================================
*/
void I2C_vidListenToBus(void)
{
	TWCR = ((1<<INT_FLAG) | (1<<ENABLE_ACK) | (1<<I2C_ENABLE));
	while ((TWCR & (1 << INT_FLAG)) == 0);
}
/*
###########################################################################################################
##############################################  MASTER & SLAVE  ###########################################
############################################  Sending & Receiving  ########################################
###########################################################################################################
*/
/*
===========================================================================================================
                                          ##### Sending Data #####
===========================================================================================================
*/
void I2C_vidSend(u8 data)
{
  TWDR=data;
  //TWINT MUST be cleared before any operation
  TWCR=((1<<INT_FLAG)|(1<<I2C_ENABLE));
  while ((TWCR & (1 << INT_FLAG)) == 0);
}
/*
===========================================================================================================
                                     ##### Receiving Data and send ACK #####
===========================================================================================================
*/
u8 I2C_u8ReceiveAck(void)
{
	TWCR = ((1<<INT_FLAG) | (1<<ENABLE_ACK) | (1<<I2C_ENABLE));
	while ((TWCR & (1 << INT_FLAG)) == 0);
	return(TWDR);
}
/*
===========================================================================================================
                                    ##### Receiving Data and send NOT ACK #####
===========================================================================================================
*/
u8 I2C_u8ReceiveNotAck(void)
{
	TWCR = ((1<<INT_FLAG) | (1<<I2C_ENABLE));
	while ((TWCR & (1 << INT_FLAG)) == 0);
	return(TWDR);
}
/*
===========================================================================================================
                                           ##### Get I2C Bus Status #####
===========================================================================================================
*/
u8 I2C_u8GetStatus(void)
{
	u8 status;
	status=(TWSR&0xF8);
	return(status);
}
